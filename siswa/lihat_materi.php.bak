<?php
session_start();
require_once '../includes/check_session.php';
require_once '../includes/check_role.php';
check_role(['siswa']);
require_once '../config/database.php';
require_once '../includes/functions.php';

$siswa_id = (int)$_SESSION['user_id'];
$kelas_id = isset($_SESSION['kelas_id']) ? (int)$_SESSION['kelas_id'] : 0;

// Ambil daftar mapel (berdasarkan assignment_guru untuk kelas siswa)
$sql_mapel = "
    SELECT DISTINCT mp.id AS mapel_id, mp.nama_mapel
    FROM assignment_guru ag
    JOIN mata_pelajaran mp ON ag.mapel_id = mp.id
    WHERE ag.kelas_id = {$kelas_id}
    ORDER BY mp.nama_mapel
";
$mapel_opts = fetch_all(query($sql_mapel));

$mapel_id = isset($_GET['mapel_id']) ? (int)$_GET['mapel_id'] : 0;
$keyword  = isset($_GET['q']) ? trim($_GET['q']) : '';

// Ambil materi berdasarkan kelas siswa (opsional filter mapel dan keyword judul)
$sql_materi = "
    SELECT m.id,
           m.judul_materi,
           m.deskripsi,
           m.file_path,
           m.tanggal_upload,
           mp.nama_mapel,
           u.nama_lengkap AS nama_guru
    FROM materi m
    JOIN assignment_guru ag ON m.assignment_id = ag.id
    JOIN mata_pelajaran mp ON ag.mapel_id = mp.id
    JOIN users u ON ag.guru_id = u.id
    WHERE ag.kelas_id = {$kelas_id}
";
if ($mapel_id > 0) {
    $sql_materi .= " AND mp.id = {$mapel_id}";
}
if ($keyword !== '') {
    $kw = escape_string('%'.$keyword.'%');
    $sql_materi .= " AND m.judul_materi LIKE '{$kw}'";
}
$sql_materi .= " ORDER BY m.tanggal_upload DESC";
$materi_rows = fetch_all(query($sql_materi));

?><!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Materi Pembelajaran - Siswa</title>
  <link rel="stylesheet" href="../assets/css/style.css">
  <style>
    .container{max-width:1100px;margin:10px auto;padding:10px}
    .card{background:#fff;border:1px solid #ddd;border-radius:8px;margin-bottom:12px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.04)}
    .card-header{padding:12px 16px;background:#f5f5f5;font-weight:600;display:flex;justify-content:space-between;align-items:center}
    .card-body{padding:16px}
    .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-weight:600}
    input[type=text],select{padding:10px;border:1px solid #ced4da;border-radius:6px}
    .btn{display:inline-block;padding:10px 14px;border-radius:6px;border:1px solid #2c7be5;background:#2c7be5;color:#fff;text-decoration:none;cursor:pointer}
    .btn:hover{filter:brightness(0.95)}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border:1px solid #e5e5e5;padding:10px}
    .table th{background:#fafafa;text-align:left}
    .muted{color:#64748b;font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="card-header">
        <div>Materi Pembelajaran</div>
        <div>
          <a href="dashboard.php" class="btn">Kembali</a>
        </div>
      </div>
      <div class="card-body">
        <form method="get" class="filters">
          <div>
            <label>Mapel</label>
            <select name="mapel_id" onchange="this.form.submit()">
              <option value="">Semua Mapel</option>
              <?php foreach ($mapel_opts as $m): ?>
                <option value="<?php echo (int)$m['mapel_id']; ?>" <?php echo $mapel_id==(int)$m['mapel_id']?'selected':''; ?>>
                  <?php echo htmlspecialchars($m['nama_mapel']); ?>
                </option>
              <?php endforeach; ?>
            </select>
          </div>
          <div>
            <label>Cari Judul</label>
            <input type="text" name="q" value="<?php echo htmlspecialchars($keyword); ?>" placeholder="ketik judul..." />
          </div>
          <div>
            <button type="submit" class="btn">Terapkan</button>
          </div>
        </form>

        <div style="margin-top:12px">
          <table class="table">
            <thead>
              <tr>
                <th>Judul</th>
                <th>Mapel</th>
                <th>Guru</th>
                <th>Diunggah</th>
                <th>Berkas</th>
              </tr>
            </thead>
            <tbody>
              <?php if (empty($materi_rows)): ?>
                <tr><td colspan="5">Belum ada materi.</td></tr>
              <?php else: foreach ($materi_rows as $r): ?>
                <tr>
                  <td><?php echo htmlspecialchars($r['judul_materi']); ?></td>
                  <td><?php echo htmlspecialchars($r['nama_mapel']); ?></td>
                  <td><?php echo htmlspecialchars($r['nama_guru']); ?></td>
                  <td><?php echo htmlspecialchars($r['tanggal_upload']); ?></td>
                  <td>
                    <?php if (!empty($r['file_path'])): ?>
                      <a class="btn" href="../assets/uploads/<?php echo htmlspecialchars($r['file_path']); ?>" target="_blank">Unduh</a>
                    <?php else: ?>
                      <span class="muted">Tidak ada berkas</span>
                    <?php endif; ?>
                  </td>
                </tr>
              <?php endforeach; endif; ?>
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</body>
</html>